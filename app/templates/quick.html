{% extends 'base.html' %}

{% block title %}Prompt Optimization Web App{% endblock %}

{% block content %}
<div class="text-center">
  <h2 data-i18n="quick.title">Quick Prompt Optimization</h2>

  <form method="post" class="mb-4">
    <div class="mb-3">
      <textarea
        class="form-control"
        name="user_input"
        rows="3"
        required
        maxlength="1800"
        placeholder="Enter your initial prompt idea, e.g.: 'Who was Princess Diana?', 'What is the internet?', 'What is Bitcoin?'"
        data-i18n-placeholder="quick.placeholder"
      >{{ user_input or '' }}</textarea>
    </div>

    <div class="mb-3">
      <label for="toneSelect" class="form-label" data-i18n="quick.select_tone">Select Tone:</label>
      <select class="form-select" id="toneSelect" name="tone" required>
        <option value="Standard" {% if selected_tone == 'Standard' %}selected{% endif %} data-i18n="quick.tone.standard">Standard</option>
        <option value="Technical" {% if selected_tone == 'Technical' %}selected{% endif %} data-i18n="quick.tone.technical">Technical</option>
        <option value="Informal" {% if selected_tone == 'Informal' %}selected{% endif %} data-i18n="quick.tone.informal">Informal</option>
        <option value="Custom" {% if selected_tone == 'Custom' %}selected{% endif %} data-i18n="quick.tone.custom">
          I want to set my own custom tone
        </option>
      </select>
    </div>

    <div
      class="mb-3"
      id="customToneContainer"
      style="{% if selected_tone == 'Custom' %}display:block;{% else %}display:none;{% endif %}"
    >
      <input
        type="text"
        class="form-control"
        id="customToneInput"
        name="custom_tone"
        maxlength="180"
        placeholder="E.g.: 'Classic Shakespeare', 'Descriptive', 'Persuasive', 'Creative', etc."
        data-i18n-placeholder="quick.custom_placeholder"
        value="{{ custom_tone or '' }}"
        {% if selected_tone == 'Custom' %}required{% endif %}
      />
    </div>

    <button id="sendBtn" type="submit" class="btn btn-lg text-white" style="background-color: #6c757d;">
      <span class="btn-label" data-i18n="quick.send">Send</span>
      <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
    </button>
  </form>

  {% if response %}
    <hr>
    <div class="mb-3 text-start">
      <h5 data-i18n="quick.optimized_title">Optimized Prompt:</h5>
      <div class="d-flex align-items-start">
        <div
          id="optimizedPrompt"
          class="alert alert-secondary flex-grow-1"
          style="white-space: pre-wrap;"
        >{{ response }}</div>
        <button
          id="copyBtn"
          class="btn btn-secondary ms-2"
          type="button"
          data-i18n="quick.copy"
        >Copy</button>
      </div>

      <!-- Feedback link with translatable parts -->
      <p class="mt-2 mb-0">
        <a
          id="feedbackLink"
          href="https://forms.office.com/e/vM7W04GBxg"
          class="link-dark text-decoration-none"
          target="_blank"
          rel="noopener"
        >
          <span style="color:#dc3545; font-weight:700;">
            <span data-i18n="feedback.lead">üí¨ Got a minute? </span>
            <u><span data-i18n="feedback.here">CLICK HERE</span></u>
            <span data-i18n="feedback.tail"> and share your feedback on the Prompt Optimizer web app ‚Äî I promise it won‚Äôt even take a minute üòÑ</span>
          </span>
        </a>
      </p>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Page-level PT-BR dictionary (merged by the base script)
  window.appI18n = window.appI18n || {};
  window.appI18n.pt = Object.assign(window.appI18n.pt || {}, {
    "quick.title": "Otimiza√ß√£o de Prompt R√°pida",
    "quick.placeholder": "Digite sua ideia inicial de prompt. Ex.: ‚ÄúQuem foi a Princesa Diana?‚Äù, ‚ÄúO que √© a internet?‚Äù, ‚ÄúO que √© Bitcoin?‚Äù",
    "quick.select_tone": "Selecione o tom:",
    "quick.tone.standard": "Padr√£o",
    "quick.tone.technical": "T√©cnico",
    "quick.tone.informal": "Informal",
    "quick.tone.custom": "Quero definir um tom personalizado",
    "quick.custom_placeholder": "Ex.: ‚ÄúShakespeare cl√°ssico‚Äù, ‚ÄúDescritivo‚Äù, ‚ÄúPersuasivo‚Äù, ‚ÄúCriativo‚Äù etc.",
    "quick.send": "Enviar",
    "quick.optimized_title": "Prompt Otimizado:",
    "quick.copy": "Copiar",
    "quick.copied": "Copiado!",
    "quick.loading": "Carregando‚Ä¶",

    /* Feedback line (split in 3 parts to keep underline on HERE) */
    "feedback.lead": "üí¨ Tem um minutinho? ",
    "feedback.here": "CLIQUE AQUI",
    "feedback.tail": " e compartilhe seu feedback sobre o aplicativo Prompt Optimizer ‚Äî prometo que n√£o vai levar nem um minuto üòÑ"
  });

  function pageLang() {
    return document.documentElement.getAttribute('lang') === 'pt-BR' ? 'pt' : 'en';
  }
  function t(key, fallback) {
    const dict = (window.appI18n && window.appI18n[pageLang()]) || {};
    return dict[key] || fallback;
  }

  // Language-specific feedback URLs
  const FEEDBACK_LINKS = {
    en: "https://forms.office.com/e/vM7W04GBxg",
    pt: "https://forms.test.portugues.com/"  // <-- Portuguese form URL
  };
  function setFeedbackHref(lang) {
    const a = document.getElementById('feedbackLink');
    if (a) a.href = FEEDBACK_LINKS[lang] || FEEDBACK_LINKS.en;
  }

  document.addEventListener('DOMContentLoaded', function() {
    const toneSelect = document.getElementById('toneSelect');
    const customContainer = document.getElementById('customToneContainer');
    const customInput = document.getElementById('customToneInput');

    // Set initial feedback link based on current language
    setFeedbackHref(pageLang());

    // Patch base.html's setLang so PT/EN toggle also updates the link
    const originalSetLang = window.setLang;
    window.setLang = function(lang) {
      if (typeof originalSetLang === 'function') originalSetLang(lang);
      setFeedbackHref(lang);
    };

    // Show/hide custom-tone box
    if (toneSelect) {
      toneSelect.addEventListener('change', function() {
        if (toneSelect.value === 'Custom') {
          customContainer.style.display = 'block';
          customInput.required = true;
        } else {
          customContainer.style.display = 'none';
          customInput.required = false;
          customInput.value = '';
        }
      });
    }

    // Copy button logic (localized)
    const copyBtn = document.getElementById('copyBtn');
    const optimizedPrompt = document.getElementById('optimizedPrompt');
    if (copyBtn && optimizedPrompt) {
      copyBtn.addEventListener('click', function() {
        const text = optimizedPrompt.innerText;
        navigator.clipboard.writeText(text)
          .then(() => {
            copyBtn.textContent = t('quick.copied', 'Copied!');
            setTimeout(() => { copyBtn.textContent = t('quick.copy', 'Copy'); }, 2000);
          })
          .catch(err => { console.error('Copy failed', err); });
      });
    }
  });

  // Loading animation with i18n text
  document.querySelector('form').addEventListener('submit', function() {
    const btn = document.getElementById('sendBtn');
    const spinner = btn.querySelector('.spinner-border');
    const label   = btn.querySelector('.btn-label');
    btn.disabled = true;
    label.textContent = t('quick.loading', 'Loading‚Ä¶');
    spinner.classList.remove('d-none');
  });
</script>
{% endblock %}
